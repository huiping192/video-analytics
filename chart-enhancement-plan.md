# Chart 增强信息显示实现计划

## 项目概述
为现有的 video-analytics 项目增强 chart 功能，在图表上显示更丰富的分析信息，创建一个信息面板丰富的可视化界面。

## 当前状态分析
- ✅ 基础 chart 功能已完善（video/audio bitrate + FPS 三线图）
- ✅ 分析数据结构完整（VideoBitrateAnalysis, AudioBitrateAnalysis, FPSAnalysis）
- ✅ 可视化架构成熟（ChartGenerator, ChartConfig, 多种样式支持）
- 🎯 **需求**: 在 chart 上显示更多分析信息和技术细节

## 设计方案

### 界面布局设计
```
┌─────────────────────────────────────────────────────────┐
│  标题: Enhanced Video Analysis Dashboard                │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  主要时间序列图表区域 (占用 60% 高度)                   │
│  - Video Bitrate (蓝线)                                │
│  - Audio Bitrate (橙线)                                │
│  - FPS (绿线)                                          │
│  - 关键点标注和异常标记                                 │
│                                                         │
├─────────────────────────────────────────────────────────┤
│                信息面板区域 (占用 40% 高度)              │
│ ┌─────────────┬─────────────┬─────────────┬─────────────┐ │
│ │文件基础信息  │ 编码技术信息 │ 质量评估     │ 问题检测     │ │
│ │• 分辨率     │ • 视频编码器 │ • 码率稳定性 │ • 掉帧检测   │ │
│ │• 时长       │ • 音频编码器 │ • FPS稳定性  │ • 码率异常   │ │
│ │• 文件大小   │ • 容器格式   │ • 整体评分   │ • 质量警告   │ │
│ │• 码率总览   │ • 声道配置   │ • CBR/VBR   │ • 建议信息   │ │
│ └─────────────┴─────────────┴─────────────┴─────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 实现计划

### Phase 1: 数据扩展和架构准备
**目标**: 扩展数据结构和基础架构

#### TODO 1.1: 扩展文件信息获取
- [ ] 在 `ProcessedFile` 中添加文件大小信息
- [ ] 在 `VideoMetadata` 中添加分辨率、容器格式等信息
- [ ] 扩展 ffprobe 查询，获取更详细的编码器信息

#### TODO 1.2: 创建增强信息数据结构
- [ ] 创建 `EnhancedAnalysisInfo` 数据类
- [ ] 包含文件信息、编码信息、质量指标等
- [ ] 实现从现有分析结果生成增强信息的方法

### Phase 2: 信息面板组件开发
**目标**: 开发各个信息面板的绘制功能

#### TODO 2.1: 文件基础信息面板
- [ ] 实现 `_draw_file_info_panel()` 方法
- [ ] 显示分辨率、时长、文件大小、总体码率
- [ ] 使用表格形式清晰展示

#### TODO 2.2: 编码技术信息面板
- [ ] 实现 `_draw_codec_info_panel()` 方法
- [ ] 显示视频编码器、音频编码器、容器格式
- [ ] 显示声道数、采样率等音频参数

#### TODO 2.3: 质量评估面板
- [ ] 实现 `_draw_quality_panel()` 方法
- [ ] 码率稳定性指标 (仪表盘样式)
- [ ] FPS 稳定性评分
- [ ] CBR/VBR 类型显示
- [ ] 整体质量等级 (优秀/良好/一般/较差)

#### TODO 2.4: 问题检测面板
- [ ] 实现 `_draw_issues_panel()` 方法
- [ ] 掉帧严重区域标记
- [ ] 码率异常波动检测
- [ ] 质量问题警告图标
- [ ] 优化建议文本

### Phase 3: 主图表增强
**目标**: 增强时间序列图表的信息展示

#### TODO 3.1: 关键点标注
- [ ] 在码率曲线上标注峰值点
- [ ] 标记掉帧发生的时间点
- [ ] 添加平均线和阈值线

#### TODO 3.2: 异常区域高亮
- [ ] 高亮显示码率异常波动区域
- [ ] 用不同颜色标记掉帧严重区域
- [ ] 添加图例说明各种标记含义

### Phase 4: ChartGenerator 集成
**目标**: 将新功能集成到现有的图表生成器中

#### TODO 4.1: 新增 enhanced 图表类型
- [ ] 在 `ChartGenerator` 中添加 `generate_enhanced_chart()` 方法
- [ ] 使用 matplotlib 的 gridspec 实现复杂布局
- [ ] 支持自适应字体大小和布局调整

#### TODO 4.2: 配置选项扩展
- [ ] 在 `ChartConfig` 中添加信息面板相关配置
- [ ] 支持显示/隐藏特定信息面板
- [ ] 添加信息详细程度控制 (简洁/标准/详细)

### Phase 5: CLI 接口更新
**目标**: 为用户提供新的命令行选项

#### TODO 5.1: 命令行选项
- [ ] 在 chart 命令中添加 `--enhanced` 或 `--info-rich` 选项
- [ ] 添加 `--info-level` 选项 (basic/standard/detailed)
- [ ] 保持向后兼容性

#### TODO 5.2: 帮助文档更新
- [ ] 更新 CLI 帮助信息
- [ ] 在 CLAUDE.md 中添加新功能说明
- [ ] 提供使用示例

### Phase 6: 测试和优化
**目标**: 确保功能稳定性和用户体验

#### TODO 6.1: 功能测试
- [ ] 测试不同类型的视频文件
- [ ] 测试极端情况 (超长视频、异常码率等)
- [ ] 验证信息显示的准确性

#### TODO 6.2: 性能优化
- [ ] 优化图表渲染性能
- [ ] 确保内存使用合理
- [ ] 测试大文件处理能力

#### TODO 6.3: 用户体验优化
- [ ] 调整布局和字体，确保可读性
- [ ] 优化颜色搭配和视觉效果
- [ ] 收集用户反馈并改进

## 技术实现细节

### 关键技术点
1. **布局管理**: 使用 matplotlib.gridspec.GridSpec 实现复杂布局
2. **信息面板**: 使用 matplotlib 的 text 和 table 功能
3. **仪表盘**: 使用 matplotlib 的 pie chart 和 bar chart
4. **标注系统**: 使用 annotate 和 scatter 实现关键点标记
5. **颜色系统**: 扩展现有的颜色方案，支持更多语义化颜色

### 代码组织
```
video_analytics/visualization/
├── chart_generator.py          # 现有文件，添加 enhanced 方法
├── enhanced_panels.py          # 新文件：信息面板绘制逻辑
├── chart_layouts.py           # 新文件：布局管理
└── visual_elements.py         # 新文件：视觉元素 (仪表盘、标注等)
```

### 配置示例
```python
enhanced_config = ChartConfig(
    width=16, height=12,          # 更大的画布
    enhanced_mode=True,           # 启用增强模式
    info_level="detailed",        # 信息详细程度
    show_panels=["file_info", "codec_info", "quality", "issues"],
    panel_height_ratio=0.4        # 信息面板占总高度比例
)
```

## 预期效果

用户运行 `python -m video_analytics chart video.mp4 --enhanced` 后，将得到：

1. **信息丰富的可视化界面** - 一目了然的技术参数和质量指标
2. **问题快速识别** - 自动检测和高亮显示潜在问题
3. **专业级分析报告** - 适合技术人员和内容创作者使用
4. **可定制的信息展示** - 根据需要选择显示的信息类型

这个增强版 chart 将把你的视频分析工具提升到专业级水准！

---

## 开发进度跟踪

### Phase 1 进度
- [x] 1.1 扩展文件信息获取 ✅ (完成文件大小优化)
- [x] 1.2 创建增强信息数据结构 ✅ (创建 enhanced_analysis.py 模块)

### Phase 2 进度  
- [x] 2.1 文件基础信息面板 ✅ (实现_draw_file_info_panel方法)
- [x] 2.2 编码技术信息面板 ✅ (实现_draw_codec_info_panel方法)  
- [x] 2.3 质量评估面板 ✅ (包含仪表盘和进度条)
- [x] 2.4 问题检测面板 ✅ (状态指示器和问题统计)

### Phase 3 进度
- [ ] 3.1 关键点标注
- [ ] 3.2 异常区域高亮

### Phase 4 进度
- [ ] 4.1 新增 enhanced 图表类型
- [ ] 4.2 配置选项扩展

### Phase 5 进度
- [x] 5.1 命令行选项 ✅（新增 `--enhanced/--info-rich` 与 `--info-level`）
- [x] 5.2 帮助文档更新 ✅（更新 `CLAUDE.md` 使用说明）

### Phase 6 进度
- [ ] 6.1 功能测试
- [ ] 6.2 性能优化
- [ ] 6.3 用户体验优化

---

*准备好开始实施这个计划了吗？我们可以从 Phase 1 开始，逐步实现每个功能。*